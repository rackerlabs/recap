name: Test distros
on:
  pull_request:
    branches:
      - master
      - development
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "centos_8"
            registry: quay.io/centos/centos:stream8
          - name: "centos_9"
            registry: quay.io/centos/centos:stream9
          - name: "ubuntu_22.04"
            registry: mirror.gcr.io/library/ubuntu:22.04
          - name: "ubuntu_20.04"
            registry: mirror.gcr.io/library/ubuntu:20.04
          - name: "debian_11"
            registry: mirror.gcr.io/library/debian:bullseye
          - name: "fedora_latest"
            registry: registry.fedoraproject.org:fedora:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Run container
        run: >
          podman run
          --pull always
          --detach
          --rm
          --tty
          --privileged
          --network=host
          --name ${{ matrix.name }}
          --mount type=bind,src="$(pwd)",dst=/recap
          ${{ matrix.registry }}

      - name: Install in container
        run: >
          podman exec
          ${{ matrix.name }}
          bash -c '/recap/tests/install_deps.sh ${{ matrix.name }} && /recap/tests/test_install_recap.sh'

      - name: Run Tests in container
        run: |
          podman exec ${{ matrix.name }} bash -c 'recap --version'
          podman exec ${{ matrix.name }} bash -c 'recaplog --version'
          podman exec ${{ matrix.name }} /recap/tests/run_recap.sh
          podman exec ${{ matrix.name }} bash -c 'ls -tr /var/log/recap/*log | xargs tail -v -n+0'
          podman exec ${{ matrix.name }} /recap/tests/run_recaplog.sh
          podman exec ${{ matrix.name }} bash -c 'tail -v -n+0 /var/log/recap/recaplog.log'
          podman exec ${{ matrix.name }} bash -c 'recap -p list'
          podman exec ${{ matrix.name }} bash -c 'recap -p list enabled'
          podman exec ${{ matrix.name }} bash -c 'recap -p enable all'
          podman exec ${{ matrix.name }} bash -c 'recap -p list enabled'
          podman exec ${{ matrix.name }} bash -c 'recap -p list disabled'
          podman exec ${{ matrix.name }} bash -c 'recap -p disable all'
          podman exec ${{ matrix.name }} bash -c 'recap -p list disabled'
          podman exec ${{ matrix.name }} bash -c 'recap -p list enabled'
